def COLOR_MAP = [
    'SUCCESS': 'good',
    'FAILURE': 'danger',
    'ABORTED': '#808080'
]

pipeline {
    agent any

    tools {
        nodejs 'node16'
        jdk 'jdk17'
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'

        AWS_REGION   = 'ap-south-1'
        ECR_REGISTRY = '126830716304.dkr.ecr.ap-south-1.amazonaws.com'
        ECR_REPO     = 'demo-app'
        IMAGE_NAME   = "${ECR_REGISTRY}/${ECR_REPO}"

        DOCKERHUB_IMAGE = "ariphmohd1993/flipkart"
    }

    stages {

        stage("Clean Workspace") {
            steps {
                cleanWs()
            }
        }

        stage("Git Checkout") {
            steps {
                git branch: 'main',
                    url: 'https://github.com/ariphmohd/Flipkart-Clone-DevSecops-EKS-Scout-OWASP-ZAP-Gitops-Hard-Level-project.git'
            }
        }

        stage("Install Dependencies") {
            steps {
                sh "npm install"
            }
        }

        stage("SonarQube Analysis") {
            steps {
                withSonarQubeEnv('sonar-server') {
                    sh """
                    ${SCANNER_HOME}/bin/sonar-scanner \
                    -Dsonar.projectName=flipkart \
                    -Dsonar.projectKey=flipkart \
                    -Dsonar.exclusions=node_modules/**,**/*.spec.js
                    """
                }
            }
        }

         stage("Quality Gate") {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true,
                                       credentialsId: 'sonar-token'
                }
            }
        }

        /*stage("Quality Gate (SKIPPED)") {
           steps {
                echo "‚ö†Ô∏è Quality Gate check is temporarily skipped to test downstream stages."
                echo "‚ÑπÔ∏è Sonar analysis has already been submitted successfully."
            }
        } */


        stage("OWASP Dependency Check Scan") {
            steps {
                withCredentials([string(credentialsId: 'nvd-api-key', variable: 'NVD_API_KEY')]) {

                    dependencyCheck(
                        additionalArguments: """
                            --scan .
                            --exclude node_modules/**
                            --exclude dist/**
                            --exclude build/**
                            --exclude coverage/**
                            --exclude .git/**
                            --disableYarnAudit
                            --disableNodeAudit
                            --nvdApiKey ${NVD_API_KEY}
                        """,
                        odcInstallation: 'dp-check'
                    )
                }

                dependencyCheckPublisher pattern: '**/dependency-check-report.*'
            }
        }




        /* =======================
           REPLACED Docker Scout
           WITH TRIVY (ONLY CHANGE)
           ======================= */

        stage("Trivy Filesystem Scan") { 
            steps {
                sh '''
                docker run --rm \
                  -v $(pwd):/project \
                  aquasec/trivy:latest fs /project \
                  --severity HIGH,CRITICAL \
                  --format table
                '''
            }
        }

        stage("Build Docker Image") {
            steps {
                sh """
                docker build -t flipkart:${BUILD_NUMBER} .
                docker tag flipkart:${BUILD_NUMBER} ${DOCKERHUB_IMAGE}:${BUILD_NUMBER}
                docker tag flipkart:${BUILD_NUMBER} ${DOCKERHUB_IMAGE}:latest
                """
            }
        }

        stage("Trivy Image Scan") {
            steps {
                sh '''
                docker run --rm \
                  -v /var/run/docker.sock:/var/run/docker.sock \
                  aquasec/trivy:latest image flipkart:${BUILD_NUMBER} \
                  --severity HIGH,CRITICAL \
                  --format table
                '''
            }
        }

        stage("Push Image to DockerHub") {
            steps {
                withCredentials([string(credentialsId: 'docker-cred',
                                        variable: 'DOCKER_PASS')]) {
                    sh """
                    docker login -u ariphmohd1993 -p ${DOCKER_PASS}
                    docker push ${DOCKERHUB_IMAGE}:${BUILD_NUMBER}
                    docker push ${DOCKERHUB_IMAGE}:latest
                    docker logout
                    """
                }
            }
        }

        stage("Upload App Image to ECR (IAM Role)") {
            steps {
                sh """
                aws sts get-caller-identity

                aws ecr get-login-password --region ${AWS_REGION} \
                  | docker login --username AWS --password-stdin ${ECR_REGISTRY}

                docker tag flipkart:${BUILD_NUMBER} ${IMAGE_NAME}:${BUILD_NUMBER}
                docker tag flipkart:${BUILD_NUMBER} ${IMAGE_NAME}:latest

                docker push ${IMAGE_NAME}:${BUILD_NUMBER}
                docker push ${IMAGE_NAME}:latest

                docker logout ${ECR_REGISTRY}
                """
            }
        }

        stage("Deploy to Container") {
            steps {
                sh '''
                docker rm -f flipkart || true
                docker run -d --name flipkart -p 80:80 ${DOCKERHUB_IMAGE}:latest
                '''
            }
        }

        stage("DAST Scan with OWASP ZAP") {
            steps {
                sh '''
                docker run --rm \
                  -v $(pwd):/zap/wrk \
                  zaproxy/zap-stable zap-baseline.py \
                  -t http://localhost \
                  -r zap_report.html -J zap_report.json || true
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'zap_report.html,zap_report.json',
                                     allowEmptyArchive: true
                }
            }
        }
    }

    /* =========================
       üîî SAME NOTIFICATIONS
       AS YOUR ORIGINAL FILE
       ========================= */

    post {
        always {
            script {
                def buildStatus = currentBuild.currentResult
                def buildUser = currentBuild
                        .getBuildCauses('hudson.model.Cause$UserIdCause')[0]
                        ?.userId ?: 'GitHub User'
                def buildUrl = env.BUILD_URL

                // Slack Notification
                slackSend(
                    channel: '#devsecops',
                    color: COLOR_MAP[buildStatus],
                    message: """*${buildStatus}:* Job *${env.JOB_NAME}* Build #${env.BUILD_NUMBER}
üë§ *Started by:* ${buildUser}
üîó *Build URL:* <${buildUrl}|Click Here for Details>"""
                )

                // Email Notification
                def attachments = []

                if (fileExists('dependency-check-report.xml')) {
                    attachments << 'dependency-check-report.xml'
                }
                if (fileExists('zap_report.html')) {
                    attachments << 'zap_report.html'
                }
                if (fileExists('zap_report.json')) {
                    attachments << 'zap_report.json'
                }
                emailext(
                    subject: "Pipeline ${buildStatus}: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        <p>Flipkart DevSecOps CI/CD pipeline status.</p>
                        <p><b>Project:</b> ${env.JOB_NAME}</p>
                        <p><b>Build Number:</b> ${env.BUILD_NUMBER}</p>
                        <p><b>Status:</b> ${buildStatus}</p>
                        <p><b>Started by:</b> ${buildUser}</p>
                        <p><a href="${buildUrl}">View Build</a></p>
                        """,
                to: 'ariphmohd@gmail.com',
                    from: 'ariphmohd@gmail.com',
                    mimeType: 'text/html',
                    attachmentsPattern: attachments.join(',')
                )
            }
        }
    }
}
